# LoginBonus

Minecraft Bukkitプラグインで、ログインボーナスシステムを実装します。プレイヤーが累積ログイン時間を蓄積し、設定された目標時間に達すると報酬を与えます。

## 機能

### コア機能
- **累積ログイン時間追跡**: 各プレイヤーの累積ログイン時間を分単位で追跡します。ログイン中にリアルタイムで更新されます。
- **報酬システム**: プレイヤーが設定された目標プレイ時間に達すると、自動で報酬を付与します。インベントリが満杯の場合は地面にドロップされます。
- **ボスバーディスプレイ**: 報酬が利用可能になるまでの残り時間をリアルタイムでカスタマイズ可能なボスバーで表示します。目標達成で自動的に非表示になります。
- **サーバー停止時のデータ保存**: サーバー停止時にオンラインのプレイヤーのセッション時間を自動保存します。

### ストリークシステム
- **デイリーストリーク**: 報酬請求の連続日数を追跡します。
- **ストリークボーナス**: ストリークを維持するための追加報酬（基本報酬にストリーク分加算）。
- **特別ストリーク報酬**: 特定のストリーク日数（例: 7日目、30日目）に対する設定可能な特別報酬。
- **特別倍数報酬**: ストリーク日数の倍数（例: 5日ごと、10日ごと）に対する報酬。

### ストレージと同期
- **複数のストレージオプション**: YAMLファイル、SQLiteデータベース、MySQLデータベースから選択可能。
- **プレイヤーデータ同期**: MySQLストレージを使用する場合、複数のサーバー間でプレイヤーデータを同期。`/rewardsync` コマンドで手動同期、またはプレイヤーログイン時に自動同期。
- **データ移行**: `/rewardmigrate` コマンドでストレージタイプ間（YAML、SQLite、MySQL）のデータ移行が可能。
- **MySQLテーブル名のカスタマイズ**: config.ymlでMySQLのテーブル名を変更可能。

### データ管理
- **プレイヤーデータ削除**: 特定のプレイヤーまたは全プレイヤーのデータを削除可能。
- **自動日付変更検知**: ログイン中にリセット時刻が過ぎた場合、自動的に新しい日のトラッキングを開始。
- **一括操作**: `everyone` キーワードで全オンラインプレイヤーに対して一括でコマンドを実行可能。

### 高度な時間設定
- **カスタマイズ可能なリセット時刻**: デフォルトの0時ではなく、任意の時刻（例: 朝6時、正午など）にリセット可能。
- **設定可能なチェック間隔**: リセット時刻の確認間隔を設定可能（デフォルト: 30秒）。
  - **重要**: 安全のため、チェック間隔は5秒〜3600秒（1時間）の範囲に自動制限されます。
  - 5秒未満に設定した場合は自動的に5秒に調整されます。
  - 3600秒を超える場合は自動的に3600秒に調整されます。

### 設定
- **設定可能な報酬**: `config.yml`で報酬アイテム、数量、メッセージを定義します。
- **メッセージカスタマイズ**: `message.yml`で全てのプラグインメッセージをカスタマイズします（50以上のメッセージ、プレースホルダーサポート付き）。
- **ボスバーカスタマイズ**: ボスバーの色、スタイル、タイトルを設定します。
- **時間設定**: 目標プレイ時間、リセット時刻、チェック間隔などを設定します。
- **ストレージタイプ**: `config.yml`でデータストレージをYAML、SQLite、またはMySQLから選択できます。
- **MySQLテーブル名**: MySQLストレージのテーブル名をカスタマイズ可能。

## コマンド

### プレイヤーコマンド
- `/rewardstreak`  
  現在のストリーク日数を確認します。

### 管理者コマンド（OP権限または `loginbonus.admin` 権限が必要）

**注意**: 以下のコマンドは `<player>` の代わりに `everyone` を指定することで、全オンラインプレイヤーに一括適用できます。

- `/rewardreload`  
  サーバーを再起動せずに設定ファイル（`config.yml`、`playerdata.yml`、`message.yml`）をリロードします。
  
- `/rewardforcegive <player|everyone>`  
  指定されたプレイヤーまたは全オンラインプレイヤーにプレイ時間に関係なく強制的に報酬を付与します。テストや手動報酬に便利です。
  - 例: `/rewardforcegive PlayerName` - 特定プレイヤーに報酬付与
  - 例: `/rewardforcegive everyone` - 全オンラインプレイヤーに報酬付与
  
- `/rewardsetstreak <player|everyone> <days>`  
  指定されたプレイヤーまたは全オンラインプレイヤーのストリークカウントを指定された日数に設定します。最後のストリーク日付も現在の日付に更新されます。
  - 例: `/rewardsetstreak PlayerName 7` - 特定プレイヤーのストリークを7日に設定
  - 例: `/rewardsetstreak everyone 10` - 全オンラインプレイヤーのストリークを10日に設定
  
- `/rewardresetplaytime <player|everyone>`  
  指定されたプレイヤーまたは全オンラインプレイヤーの累積プレイ時間を0にリセットし、ボスバーを再開始します。
  - 例: `/rewardresetplaytime PlayerName` - 特定プレイヤーの累積時間をリセット
  - 例: `/rewardresetplaytime everyone` - 全オンラインプレイヤーの累積時間をリセット
  
- `/rewardsync [player|everyone]`  
  MySQLストレージを使用している場合、プレイヤーデータをデータベースから同期します。複数のサーバー間でデータを更新する際に使用。
  - 引数なし: 自分自身のデータを同期
  - `[player]`指定: 指定したプレイヤーのデータを同期
  - `everyone`指定: 全オンラインプレイヤーのデータを同期
  
- `/rewardmigrate <yaml|sqlite|mysql> <yaml|sqlite|mysql>`  
  プレイヤーデータをストレージタイプ間で移行します。全てのプレイヤーデータが移行されます。
  - 例: `/rewardmigrate yaml mysql` - YAMLからMySQLへ移行
  - 例: `/rewardmigrate sqlite mysql` - SQLiteからMySQLへ移行
  - 例: `/rewardmigrate mysql yaml` - MySQLからYAMLへ移行
  
- `/rewarddeleteplayer <player>`  
  指定されたプレイヤーのデータを完全に削除します（累積時間、ストリーク、最終報酬日など）。
  - オンラインの場合はトラッキングもキャンセルされます
  
- `/rewarddeleteall confirm`  
  全てのプレイヤーデータを削除します。**この操作は取り消せません。**
  - 安全のため、`confirm`パラメータの入力が必須です
  - オンラインの全プレイヤーのトラッキングがキャンセルされます

## 設定ファイル

### config.yml
`plugins/LoginBonus/config.yml`にあります。報酬、ボスバー設定、その他のプラグインオプションを定義します。

例の構造:
```yaml
# ================================
# ログイン報酬プラグイン設定ファイル
# ================================
# このファイルでログイン報酬の動作をカスタマイズできます。
# 変更後はサーバーを再起動するか、/rewardreload コマンドでリロードしてください。

# ================================
# ストレージ設定
# ================================
# プレイヤーデータの保存方法
# yaml: YAMLファイルに保存（デフォルト）
# sqlite: SQLiteデータベースに保存
# mysql: MySQLデータベースに保存（マルチサーバー対応）
storage-type: yaml

# MySQL設定（storage-type: mysql の場合のみ使用）
mysql:
  host: localhost
  port: 3306
  database: loginbonus
  table-name: player_data  # テーブル名（デフォルト: player_data）
  username: root
  password: password
  # 接続プール設定
  connection-pool:
    maximum-pool-size: 10
    minimum-idle: 2
    connection-timeout: 30000

# ================================
# 基本設定
# ================================
# 報酬を受け取るための累積ログイン時間（分単位）
# 例: 30 → 30分ログインで報酬
reward-time: 1

# 累積ログイン時間のリセット時刻（24時間形式、時:分）
# 例: "00:00" → 0時にリセット、"06:00" → 6時にリセット
# この時刻に達すると、プレイヤーの累積時間がリセットされ、新しい日として扱われます
reset-time: "00:00"

# リセット時刻チェック間隔（秒単位）
# 何秒ごとに現在時刻を確認してリセット時刻に達したかチェックするか
# 例: 30 → 30秒ごと、60 → 1分ごと、10 → 10秒ごと
# 注意: 短すぎる間隔（5秒未満）はサーバーに負荷をかける可能性があります
# 重要: 安全のため5秒〜3600秒（1時間）の範囲に自動制限されます
reset-check-interval: 30

# 報酬アイテムのリスト
# 各アイテムのMaterial名と個数を指定
# ストリーク機能が有効の場合、個数がストリーク分加算されます
reward-items:
  - item: DIAMOND
    amount: 1

# ================================
# ストリーク設定
# ================================
# ストリーク機能を有効にするかどうか
# true: 連続ログインで報酬が増える / false: 無効
streak-enabled: true

# ================================
# 特殊ストリーク報酬設定（個別日数）
# ================================
# 特殊ストリーク報酬を有効にするかどうか
# true: 指定した個別日数での報酬を支給 / false: 無効
special_streak_rewards:
  enabled: true
  rewards:
    '7':
      items:
        - type: EMERALD
          amount: 7
      message: "&b7日連続ログイン！エメラルド7個プレゼント！"
    '30':
      items:
        - type: NETHERITE_INGOT
          amount: 1
      message: "&d30日連続ログイン！ネザライトインゴット1個プレゼント！"

# ================================
# 特殊倍数ストリーク報酬設定（倍数日数）
# ================================
# 特殊倍数ストリーク報酬を有効にするかどうか
# true: 指定した倍数日数での報酬を支給 / false: 無効
special_multiple_rewards:
  enabled: true
  multiples:
    '5':
      items:
        - type: GOLD_INGOT
          amount: 2
      message: "&e%days%日連続ログイン！ゴールドインゴット2個プレゼント！"
    '10':
      items:
        - type: GOLD_INGOT
          amount: 4
      message: "&e%days%日連続ログイン！ゴールドインゴット4個プレゼント！"

# ================================
# ボスバー設定
# ================================
# ボスバーのタイトル
# %remaining% で残り時間が表示されます
# Minecraftの装飾コードを使用可能（例: &a = 緑色）
boss-bar-title: "&a報酬まで残り: %remaining%"

# ボスバーの色
# BarColorの値: BLUE, GREEN, PINK, PURPLE, RED, WHITE, YELLOW
boss-bar-color: BLUE

# ボスバーのスタイル
# BarStyleの値: SOLID, SEGMENTED_6, SEGMENTED_10, SEGMENTED_12, SEGMENTED_20
boss-bar-style: SOLID
```

### message.yml
`plugins/LoginBonus/message.yml`にあります。**プラグインの全てのメッセージをカスタマイズできます**。

このファイルでは50以上のメッセージが設定可能で、以下のカテゴリに分類されています：
- 報酬関連メッセージ
- コマンド権限・使用法メッセージ
- 一般的なエラーメッセージ
- 各コマンド専用メッセージ

プレースホルダーのサポート: `%player%`, `%streak%`, `%days%`, `%count%`, `%from%`, `%to%`, `%type%`, `%error%`, `%old%`, `%new%`, `%command%`

例:
```yaml
# ================================
# メッセージ設定ファイル
# ================================
# このファイルでプラグインのメッセージをカスタマイズできます。
# Minecraftの装飾コードを使用可能（例: &e = 黄色、&c = 赤色）。
# プレースホルダー: %player%, %streak%, %days%, %count%, %from%, %to%, %type%

# ================================
# 報酬関連メッセージ
# ================================
reward-message: "&e報酬を受け取りました！"
reward-synced: "&aデータが同期されました。"

# ================================
# コマンド権限・使用法メッセージ
# ================================
no-permission: "&cこのコマンドはOP権限が必要です。"
no-permission-admin: "&cこのコマンドを実行する権限がありません。"
player-only: "&cこのコマンドはプレイヤーのみ実行可能です。"

# ================================
# 一般的なエラーメッセージ
# ================================
player-not-found: "&cプレイヤー '%player%' が見つかりません。"
invalid-number: "&cストリークは数値で指定してください。"
number-must-be-positive: "&cストリークは0以上で指定してください。"

# ... 他50以上のメッセージ設定が可能 ...
```

完全なメッセージリストは `src/main/resources/message.yml` を参照してください。

### playerdata.yml / playerdata.db / MySQLテーブル
YAMLストレージの場合: `plugins/LoginBonus/playerdata.yml`にあります。プレイヤーデータ（累積時間、ストリーク、最後の報酬）を保存します。手動で編集しないでください。

SQLiteストレージの場合: `plugins/LoginBonus/playerdata.db`にあります。データベース形式でプレイヤーデータを保存します。手動編集は推奨されません。

MySQLストレージの場合: 指定されたMySQLデータベースに`playerdata`テーブルが作成され、プレイヤーデータが保存されます。テーブルスキーマはUUID（主キー）、cumulative（累積時間）、lastReward（最後の報酬日）、streak（ストリーク）、lastSync（最終同期タイムスタンプ）です。

## インストール

1. プラグインのJARファイルをダウンロードします。
2. JARをサーバーの`plugins/`フォルダに配置します。
3. サーバーを再起動するか、`/reload`を使用します（本番環境では推奨されません）。
4. 必要に応じてconfig.ymlとmessage.ymlを設定します。
5. SQLiteストレージを使用する場合、SQLite JDBCドライバがサーバーに利用可能であることを確認してください（プラグインにバンドルされています）。
6. MySQLストレージを使用する場合、MySQLサーバーをセットアップし、config.ymlに接続情報を設定してください。MySQL JDBCドライバが利用可能であることを確認（プラグインにバンドルされています）。
7. 設定を変更した場合、`/rewardreload` コマンドを使用するか、再びサーバーを再起動します。

## パーミッション

- **報酬を受け取る**: 権限不要（全プレイヤーが自動的に受け取れます）
- **`/rewardstreak`**: 権限不要（全プレイヤーが使用可能）
- **管理者コマンド**: `OP権限` または `loginbonus.admin` が必要
  - `/rewardreload` - `loginbonus.reload`
  - `/rewardforcegive` - `loginbonus.admin`
  - `/rewardsetstreak` - `loginbonus.admin`
  - `/rewardresetplaytime` - `loginbonus.admin`
  - `/rewardsync` - `loginbonus.admin`
  - `/rewardmigrate` - `loginbonus.admin`
  - `/rewarddeleteplayer` - `loginbonus.admin`
  - `/rewarddeleteall` - `loginbonus.admin`

**注意**: バージョン1.3.2以降、権限名が `lgb01.*` から `loginbonus.*` に変更されました。既存の権限設定を更新してください。

## 互換性

- **Minecraftバージョン**: 1.19.4 (Spigot API 1.19.4-R0.1-SNAPSHOT)
- **Javaバージョン**: 17
- **Bukkit/Spigot/Paper**: 標準的なBukkit実装と互換。
- **ストレージ**: YAML、SQLite、またはMySQLデータベース。

## 開発

- **ソースコード**: GitHubで利用可能。
- **ビルド**: Gradleを使用してプロジェクトをビルドします。
- **依存関係**: Spigot APIが必要です。SQLiteストレージを使用する場合、SQLite JDBCドライバが含まれます。MySQLストレージを使用する場合、MySQL JDBCドライバが含まれます。
- **Minecraftバージョンの変更**: プラグインを別のMinecraftバージョン（例: 1.21.8）に対応させるには、`build.gradle` のSpigot API依存関係を更新し（例: `compileOnly 'org.spigotmc:spigot-api:1.21.3-R0.1-SNAPSHOT'`）、`src/main/resources/plugin.yml` の `api-version` を変更してください（例: `api-version: 1.21`）。また、README.mdの互換性セクションを更新します。MinecraftのAPI変更に注意し、テストを行ってください。（変更の仕方などがよく分からない方はGitHub CopilotなどのAIに質問してみてください）

## ライセンス

このプラグインはMITライセンスで公開されています。

## サポート

問題や質問については、GitHubリポジトリでissueを作成してください。

## 貢献者
このプラグインの開発では、GitHub Copilotがコード生成とドキュメント支援を提供しました。

## 更新履歴

### バージョン 1.3.2 (最新)

#### 問題修正
- ✨ **ログイン中の日付変更時に自動トラッキング再開**
  - リセット時刻を検出すると、既に報酬を受け取ったオンラインプレイヤーのトラッキングを自動的に再開
  - 設定可能なチェック間隔でリセット時刻を監視
- ✨ **message.yml自動更新**
  - 既存のカスタマイズを保持しながら、新しいメッセージを自動追加
  - 不要なメッセージ（already-claimed-message、not-enough-time-message）を削除

#### 新機能 - メッセージカスタマイズ
- ✨ **全メッセージの設定化**
  - message.ymlで50以上のプラグインメッセージを編集可能
  - プレースホルダーサポート: `%player%`, `%streak%`, `%days%`, `%count%`, `%from%`, `%to%`, `%type%`, `%error%`, `%old%`, `%new%`, `%command%`
  - カテゴリ別に整理: 権限エラー、コマンド使用法、成功/失敗メッセージなど

#### 新機能 - データ管理とストレージ
- ✨ **MySQLテーブル名のカスタマイズ**
  - config.ymlでMySQLのテーブル名を設定可能（デフォルト: player_data）
- ✨ **YAML/SQLite/MySQL間の相互データ移行**
  - `/rewardmigrate` コマンドで任意のストレージ間でデータ移行可能
  - 全プレイヤーデータを一括移行
- ✨ **プレイヤーデータ削除コマンド**
  - `/rewarddeleteplayer <player>` - 特定プレイヤーのデータを削除
  - `/rewarddeleteall confirm` - 全プレイヤーデータを削除（確認必須）

#### 新機能 - 一括操作（"everyone"キーワード）
- ✨ **全プレイヤーへの一括コマンド実行**
  - コマンドで `everyone` を指定すると全オンラインプレイヤーに適用
  - 対応コマンド: `/rewardsync everyone`, `/rewardforcegive everyone`, `/rewardsetstreak everyone <日数>`, `/rewardresetplaytime everyone`
  - 実行時に対象プレイヤー数を表示

#### 新機能 - カスタマイズ可能な時間設定
- ✨ **リセット時刻のカスタマイズ**
  - config.ymlで `reset-time` オプションを追加（デフォルト: "00:00"）
  - 任意の時刻（例: "06:00"で朝6時、"12:00"で正午）にリセット可能
  - プレイヤーの累積時間とストリークが設定した時刻にリセット
- ✨ **リセット時刻チェック間隔の設定**
  - config.ymlで `reset-check-interval` オプションを追加（デフォルト: 30秒）
  - 何秒ごとに現在時刻を確認するか設定可能
  - **重要**: 安全のため、5秒〜3600秒（1時間）の範囲に自動制限されます
    - 5秒未満に設定した場合は自動的に5秒に調整
    - 3600秒を超える場合は自動的に3600秒に調整
    - 起動時にログで設定されたチェック間隔を表示

#### その他の変更
- 🔧 **権限名の変更**
  - 全ての権限を `lgb01.*` から `loginbonus.*` に変更
  - `lgb01.reload` → `loginbonus.reload`
  - `lgb01.admin` → `loginbonus.admin`
- 🔧 **plugin.yml更新**
  - コマンド使用法を `<player|everyone>` 形式に更新
- 📝 **README.md全面更新**
  - 全ての新コマンドの詳細説明を追加
  - 権限セクションの更新
  - データ移行・管理機能の説明
  - MySQL設定オプションの文書化
  - メッセージカスタマイズ機能の説明
- 🐛 **コードクリーンアップ**
  - YamlStorage.javaの未使用メソッド `getPlayerData()` を削除（警告解消）

#### 互換性
- ⚠️ **権限名の変更により、既存の権限設定を更新する必要があります**
- message.ymlは自動的に新しいメッセージで更新されます（既存のカスタマイズは保持）
- reset-timeは既存の設定に影響しません（デフォルト: "00:00"で従来通り）
- reset-check-intervalは既存の設定に影響しません（デフォルト: 30秒で従来通り）
- "everyone"キーワードは既存のプレイヤー名と競合しないように大文字小文字を区別しません
- ✨ **新機能**: `/rewarddeleteall` コマンド - 全プレイヤーデータ削除（確認必須）
- ✨ **新機能**: `/rewardmigrate` コマンドでMySQLへの移行をサポート
- 🔧 **変更**: 権限名を `lgb01.*` から `loginbonus.*` に変更
- 🔧 **変更**: `/rewardsync` コマンドで他プレイヤーの同期が可能に
- 🔧 **最適化**: 日付変更チェックを30秒間隔に変更（パフォーマンス改善）
- 🐛 **修正**: ログイン中に0時を過ぎても報酬カウントが再開されない問題を修正



